<project name="dist" default="dist">
  <description>
  Provides the target for building a distribution of all of the Hackystat services.
  </description>

  <import file="build.xml"/>
    
  <target name="dist" description="Create a distribution package.">
    <!-- Define the directories and distribution name -->
    <property name="dist.dir" location="${system.build.dir}/system" />
    <property name="dist.tmp.dir" location="${basedir}/dist-tmp" />

    <!-- Copy service distribution files to the tmp dir. -->
    <property name="dist.services.name" value="hackystat-services-${version}" />
    <mkdir dir="${dist.tmp.dir}/${dist.services.name}/${dist.services.name}" />
    <copy todir="${dist.tmp.dir}/${dist.services.name}/${dist.services.name}/">
      <fileset dir="${dist.dir}/services"/>
      <fileset file="${basedir}/README.html"/>
    </copy>
  	
    <!-- Copy sensor distribution files to the tmp dir. -->
    <property name="dist.sensors.name" value="hackystat-sensors-${version}" />
    <mkdir dir="${dist.tmp.dir}/${dist.sensors.name}/${dist.sensors.name}" />
    <copy todir="${dist.tmp.dir}/${dist.sensors.name}/${dist.sensors.name}/">
      <fileset dir="${dist.dir}/sensors"/>
      <fileset file="${basedir}/README.html"/>
    </copy>

    <!-- Create the zip distribution of this system, and then delete the tmp dir. -->
    <zip zipfile="${basedir}/hackystat-services-${version}.zip" basedir="${dist.tmp.dir}/${dist.services.name}" />
    <zip zipfile="${basedir}/hackystat-sensors-${version}.zip" basedir="${dist.tmp.dir}/${dist.sensors.name}" />
    <delete dir="${dist.tmp.dir}"/>   
  </target>
	
  <target name="upload" description="Upload the distribution to google code">
  	<!-- Override this property on the command line to change. -->
  	<property name="googlecode.upload.jar" value="ant-googlecode-0.0.0test.jar"/>
	<available file="${env.GOOGLECODE_UPLOAD_HOME}/${googlecode.upload.jar}" type="file" property="googlecode.upload.available"/>
  	<fail message="Could not find ${env.GOOGLECODE_UPLOAD_HOME}/${googlecode.upload.jar}.  This task requires the GoogleCode upload ant task to be downloaded and GOOGLECODE_UPLOAD_HOME defined" unless="googlecode.upload.available"/>
  	 
    <taskdef classname="net.bluecow.googlecode.ant.GoogleCodeUploadTask" classpath="${env.GOOGLECODE_UPLOAD_HOME}/${googlecode.upload.jar}" name="gcupload"/>
	<echo message="***** Starting upload of hackystat-services-${version}.zip"/>
    <gcupload username="${svn.username}" password="${svn.password}" projectname="hackystat"
		      filename="${basedir}/hackystat-services-${version}.zip" targetfilename="hackystat-services-${version}.zip"
			  summary="System Services Distribution ${RELEASEDATE}" />
	<echo message="***** Starting upload of hackystat-sensors-${version}.zip"/>
    <gcupload username="${svn.username}" password="${svn.password}" projectname="hackystat"
		      filename="${basedir}/hackystat-sensors-${version}.zip" targetfilename="hackystat-sensors-${version}.zip"
			  summary="System Sensors Distribution ${RELEASEDATE}" />
	<echo message="Finished upload. You may want to set these files to be FEATURED."/>
  </target>


</project>

